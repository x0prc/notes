## Basics of hyperdbg
### Events
- `!syscall 0x55 pid b40 script {printf("hey, test");}`
### Extension
- `!epthook nt!ExAllocatePoolWithTag core 2 condition {48 31 c0 c3} code {90 90 c3}`
- ![[Pasted image 20251016225111.png]]
## Subsystems
- ![[Pasted image 20251016225213.png]]
## Symbol Path Configs
- `.sympath SRV *c:\Symbols* https://msdl.microsoft.com/download/symbols`
## Meta Commands
- `.debug` prepare and connect to debugger.
- `.sympath` set the symbol server.
- `.sym` load pdb symbols.
- `~` display and change the current operating core.
## Process Data Structures
- `nt!_EPROCESS` represents each windows process by a structure.
- `nt_ETHREAD` consecutively gives the working thread. 
## Debugging Processes & Threads
- `.process2` uses the changes of the cr3 register to intercept process changes.
	- Same for threads.
- `.process list` lists the current processes.
- `.thread list process ffff948cc1590340` For threads attached to processes.
- `lm` to list loaded modules.
## Virtual Memory
- `sb` : Search in byte format
- `sd` : dword format
- `sq` : qword format
- `u` for disassembly
## Stack, Heaps and Pools
- `k` for callstack.
	- `kq` or `kd` for backtrace.
- `dt` for display and map virtual memory.
## Function Calls
- `!track` - Track and map function calls and returns the symbols.
- `bp` to set breakpoints
- `bl` to list breakpoints
- `be` enable
- `bd` disable
- `bc` clear
- ![[Pasted image 20251022194437.png]]
- Stepping over the function.

## Events and Scripting
- ![[Pasted image 20251026223419.png]]
- Contains keywords similar to Windbg.
- Registers start with `@` in Hyperdbg.
- Pseudo Registers start with `$`.
- Can use `print` with `@rax` etc to print values of registers.
### Command Evaluation
- Done using `?` command.
- Write multiline scripts using two curly brackets.
	- `? printf("Hello World");`
	- `? @rax = 1234beef;`
### Arguments
- `.ds` extension for script files.
- Can be an expression, constant, or string. Constants are considered in hex format if no prefix is specified.
### Variables
- No types, everything is uint64.
- Globals have . prefix and local have no prefix.
### Conditionals
- if, else, elseif.
- Use any expressions, registers, pseudo registers, variables or results.
### Loops
- for, while, do while loops.
- Nested loops supported as well.
### Resource Sharing
- Create separate global variable as lock.
- Then, use spinlock_lock to acquire the lock.
- Release the lock by using spinlock_unlock.
- `? spinlock_unlock(&.my_global_variable_lock)`
### Halting Function
- `pause()`
- Debug when a particular condition is met.
- Used with events mainly.
- Breaks and gives control to kernel debugger.
### Event Functions
- `event_enable()`, `event_disable()`
- Parameter to this function is the Event ID.
- Used to manage different events.
### Interlocked Functions
- `interlocked_exchange()`, `interlocked_exchange_add()`
- Compare input values for first.
- Add two values in second.
## EPT Hooks
- Hidden breakpoints
- Change execution flow
- Create logs from parameters
- `!epthook` (Extension Page Table)
- `!epthook nt!ExAllocatePoolWithTag`
- `!epthook2` - Hidden hook with EPT for detours
## Memory Monitor
- Monitors a range of address for reads/writes/reads-and-writes.
- Ignores memory writes.
- Change memory content without modifying memory.
- `!monitor r $proc $proc+ff`
## Events List
- `event d 4` to disable event 4.
- `event e 6` to enable event 6.
- `event c` to clear all events.
## Flushing Buffers
- `flush` to remove all the saved buffers in the chip.
## System Calls
- `SYSCALL/SYSRET` emulates the command behavior.
- ```
  !syscall 0x55 script
	         if (@rd == 0x10 && @r9 != 0x5) {
			         pause();
				}
		}
  ```
## Heaven's Gate
- For threads that wish to switch between compatibility mode (32 bit) to long mode (64 bit).
- Index in System Service Dispatch Table containing array of pointers for 32 bit OS to all critical system APIs.
## Interrupt Descriptor Table
- Implements interrupt vector table.
- Triggered by : hardware, software, processor interrupts
## Model Specific Registers (MSR)
- Alternative to control registers in x86 processors.
- Read and Write commands supported by `rdmsr` and `wrmsr`.
- ```
  !msrwrite script {
	  value = 0;
	  value = @edx << 32;
	  value = value | @eax;
  }
  ```
## CPUID Hooking
- Basic hooking script
- ![[Pasted image 20251031194324.png]]
## VMCALL Monitoring
- Intercept and change executions in the VMCALL.
- ```!vmcall script {
  
		  printf("Executed at :" %llx, param1 : %11x, param2 : %11x,              @rip, @rcx, @rdx, @r8, @r9);
  
  }
  ```
## External Interrupts
- IO mapping is either Port Mapped or Memory Mapped (PMIO or MMIO).
- Memory based is x86 architecture.
## Hypervisor Models
### Page Tables
- 4kb pages on x86-64 systems. We need 12 bits in order to address a page.
- Every entry has 8 bytes and each table has a size of 4kb.
- ![[Pasted image 20251103191352.png]]
- `!pte` displays each page table entry's address and contents.
- EPT defines a layer of address translation that augments the translation of linear addresses.
- `!va2pa` virtual address to physical address.
- `!pa2va` vice versa.
### Memory Considerations
- Reading and Writing from/to memory, target address should be present and accessible.
- If page is paged out to the disk, then reading or modifying is not possible.
- Hyperdbg also checks for TSX (Transactional Synchronization Extensions).
- It is not possible to allocate memory in vmx-root.

## Logging
- `.logopen` and `.logclose` save debugger commands.
- `.ds` extensions for debugger scripts.
- Run script from CLI directly using `--script` parameter.
- Parse PE header files from `.pe` command
## Tricks
### Custom Settings
- `settings autounpause` to query the state of a setting.
- `settings autounpause on` to change the state of the option.
### Event Forwarding
- For log gathering and analyzing system behavior.
- `output create MyOutput file c:\..\..\..`
- Event creation `!syscall script { print(@rax); } output {MyOutput}`
- `output close MyOutput` at the end.
- Can use for DFIR purposes.
### Event Ignorance
- `!syscall`, `!join`, `!ioout`, `!msrread`, `!msrwrite` support event ignoring mechanism.
### Paging Memory
- `.pagein` target thread executes one instruction before pausing again after handling page fault.
- `.pagein error_code`
- ![[Pasted image 20251106222841.png]]
### Transparent Mode
- `!measure` and `!hide` to enable this mode.
- Makes hyperdbg transparent from anti debugging and anti hypervisor methods.