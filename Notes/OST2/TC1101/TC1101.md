*Trusted Computing 1101*
## Where not to use TPM
- Not as common storage. 
	- Typical size of several kb, up to 112 kB
- Not a standalone solution.
- Not for cryptographic acceleration.
- ![[Pasted image 20251121231621.png]]
## Where to use TPM
- Certificate Signing Requests
- Sealing user data
- TLS connections using keys
## Discrete TPM
- NVRAM, PCR, Cryptographic Processor are some key components
- ![[Pasted image 20251122234223.png]]
- TPM 1.2 (Deprecated)
## TPM vs fTPM
- Firmware TPM 
- ![[Pasted image 20251122234324.png]]
## vTPM
- Virtual TPM for VMs.
- Only protects VMs and not user machine.
- Secure Elements used in SIM Cards etc for Physical Security.
## TPM Lockout Mode
- If this error is incurred in the docker environment:

WARNING:esys:src/tss2-esys/api/Esys_Unseal.c:295:Esys_Unseal_Finish() Received TPM Error ERROR:esys:src/tss2-esys/api/Esys_Unseal.c:98:Esys_Unseal() Esys Finish ErrorCode (0x00000921) ERROR: Esys_Unseal(0x921) - tpm:warn(2.0): authorizations for objects subject to DA protection are not allowed at this time because the TPM is in DA lockout mode ERROR: Unable to run tpm2_unseal

### How to disable DA lockout mode

For hardware TPM set the DA Lockout value to 0 for deactivation. Max DA lockout values are only (2^16)-1 -> INT16MAX

### How to remove the DA lockout mode

For software TPM run the following command to remove the lockout:

tpm2_dictionarylockout –setup-parameters –max-tries=4294967295 –clear-lockout

## Cryptographic Keys
### Hierarchies
- Platform <- Objects by the OEM
- Endorsement <- Privacy Owner
- Owner <- User owned TPM objects
- NULL <- Random Seed
### Primary and Child Keys
- Primary can be asymmetric or symmetric.
- For child same as above and keyed hash type.
- Internal types contain `restricted`, `decrypt`, `sign`, `fixedtpm`, `fixedparent`, `sensitivedataorigin`, `userwithauth`
- ![[Pasted image 20251125182548.png]]
- `flushcontext` usage
	- `-t`, –transient-object: Remove all transient objects
	- `-l`, –loaded-session: Remove all loaded sessions
	- `-s`, –saved-session: Remove all saved sessions
	- Using `-tls` means flush everything.
- [tpm2_createprimary](https://github.com/tpm2-software/tpm2-tools/blob/master/man/tpm2_createprimary.1.md)
- [tpm2_create](https://github.com/tpm2-software/tpm2-tools/blob/master/man/tpm2_create.1.md)
- [algorithm specifiers](https://github.com/tpm2-software/tpm2-tools/blob/master/man/common/alg.md)
### Key Generation
- `tpm2_createprimary -c primary.ctx`
- `tpm2_sign [_OPTIONS_] [_ARGUMENT_]`
## Randomness
- `tpm2_getrandom`
- Output size is limited to the largest hash digest supported.
- Default formatting is binary and output is to stdout.
- Typically SHA384, SHA512 and minimum at SHA256.
- `tpm2_hash` used for hashing.
- `tpm2_hmac` key of keyed hash type.
- [HMAC based HOTP](https://www.ietf.org/rfc/rfc4226.txt)
## NVRAM with TPM
- Access type : 
	- Write/Read in bulk
	- Increment counter
	- Set bits
	- Use as a PCR
- Define an NV index, write/read is the typical workflow.
-  ![[Pasted image 20251130232115.png]]
- `nvdefine` creates a public info about newly reserved non-volatile memory.
- More flags like `counter`, `ownerwrite`, `ppwrite`, `authwrite`, `policywrite`.
## Protection against MiTM Attacks
- Authorization of TPM commands is used with TPM sessions.
- Parameter Encryption is used for this.
- `TPM_Create` Request contains the password for the new key in `TPM2B_SENSITIVE_CREATE`.
- Primary Key -> Secondary Key -> Child Key -> Sign Key
- Also protect NV operations from MiTM.
## Cryptography Functions
- RSA, ECC, Symmetric is built in.
- 128-bit AES static key for Symmetric Encryption.
	- `tpm2_createprimary -c primary.ctx`
	- `tpm2_rsaencrypt` and `tpm2_rsadecrypt`
## Key Persistence
- Moves a key from volatile to non volatile memory.
- Used to make keys persistent between power cycles to optimize time.
- Allows a transient object to be made persistent or to be evicted.
- `tpm2_changeauth -c o ownerauth`
- `tpm2_createprimary -c primary.ctx -P ownerauth`
## Capabilities
- `tpm2_getcap` to explore the TPM's physical capabilities and limitations.
- `tpm2_getcap properties variable` 
## API and Software Stack
![[Pasted image 20251207232329.png]]
- Provides two developer APIs
	- 1:1 mapping with TPM commands.
	- Wrapper API that simplifies the operation.
	- Invokes a user defined IO callback (function pointer).
	- User IO callback implements a custom SPI or I2C driver.
- wolfTPM works on baremetal same way it works on servers and is preferred. 
- wolfTPM wrap API provides : 
	- Prepare a new password authorization.
	- Key template.
	- Child key generation.
## Objects and Handles
- Numbering scheme that help the TPM to manage different TPM objects.
- 32 bit number, lower 24 bits can be unique, upper 8 bits are type.