## APIs
- Windows API `CreateFile`
- Native API `NtCreateFile`
- Kernel API `ZwCreateFile`
	- `ExAllocatePoolWithTag` - Kernel Only
## Processes & Threads
- Kernel tracks using a `_EPROCESS` structure and a `_ETHREAD`.
## Virtual Address Spaces
- Works by using per process page tables.
- Kernel Virtual Address Shadow (KVA Shadow) mitigation changes kernel space page table view.
## Hypervisor vs Kernel vs User
- Ring - 1 Hypervisor (All CPU instructions)
- Ring - 0 Kernel (Most CPU instructions)
- Ring - 3 User (Many CPU instructions)
## Simplified Architecture
- ![[Pasted image 20251111212136.png]]
### NTDLL.DLL
- Special system support library.
- Supports functions used by images and subsystems.
	- Image Loader
	- Heap Manager
	- Subset of CRT etc.
## I/O Processing
- ![[Pasted image 20251111212730.png]]
## Executive Layer
- Upper layer of `ntoskrnl.exe`
- Config, I/O, PnP, Power, Memory, Cache are all managed under this.
## Message Processing
- ![[Pasted image 20251111212910.png]]
## System Mechanisms
### Trap
- Processor's mechanisms for dealing with exceptions and interrupts.
### Exceptions/interrupts:
- [https://doar-e.github.io/blog/2013/10/12/having-a-look-at-the-windows-userkernel-exceptions-dispatcher/](https://doar-e.github.io/blog/2013/10/12/having-a-look-at-the-windows-userkernel-exceptions-dispatcher/)
- [https://wiki.osdev.org/Interrupt_Descriptor_Table](https://wiki.osdev.org/Interrupt_Descriptor_Table)
- [https://www.felixcloutier.com/x86/sidt](https://www.felixcloutier.com/x86/sidt)
- [https://www.felixcloutier.com/x86/lgdt:lidt](https://www.felixcloutier.com/x86/lgdt:lidt)
- [https://wiki.osdev.org/GDT_Tutorial](https://wiki.osdev.org/GDT_Tutorial)
- [https://www.felixcloutier.com/x86/sgdt](https://www.felixcloutier.com/x86/sgdt)
- [https://www.felixcloutier.com/x86/lgdt:lidt](https://www.felixcloutier.com/x86/lgdt:lidt)
- [https://ired.team/miscellaneous-reversing-forensics/windows-kernel/glimpse-into-ssdt-in-windows-x64-kernel](https://ired.team/miscellaneous-reversing-forensics/windows-kernel/glimpse-into-ssdt-in-windows-x64-kernel)

### Windows system call tables by j00ru:
- [https://github.com/j00ru/windows-syscalls](https://github.com/j00ru/windows-syscalls)
- [http://j00ru.vexillium.org/syscalls/nt/32/](http://j00ru.vexillium.org/syscalls/nt/32/)
- [http://j00ru.vexillium.org/syscalls/nt/64/](http://j00ru.vexillium.org/syscalls/nt/64/)
- [http://j00ru.vexillium.org/syscalls/win32k/32/](http://j00ru.vexillium.org/syscalls/win32k/32/)
- [http://j00ru.vexillium.org/syscalls/win32k/64/](http://j00ru.vexillium.org/syscalls/win32k/64/)

### Structure definitions:
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_EPROCESS](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_EPROCESS)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_ETHREAD](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_ETHREAD)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_EJOB](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_EJOB)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_SECTION_OBJECT_POINTERS](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_SECTION_OBJECT_POINTERS)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_FILE_OBJECT](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_FILE_OBJECT)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_TOKEN](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_TOKEN)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_KEVENT](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_KEVENT)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_KSEMAPHORE](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_KSEMAPHORE)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_KMUTANT](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_KMUTANT)
- [https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20(October%20Update%29/_CM_KEY_BODY](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1809%20Redstone%205%20\(October%20Update%29/_CM_KEY_BODY)

### Synchronization:
- [https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls](https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls)
- [https://docs.microsoft.com/en-us/windows/win32/fileio/alertable-i-o](https://docs.microsoft.com/en-us/windows/win32/fileio/alertable-i-o)
- [https://docs.microsoft.com/en-us/windows/win32/sync/wait-functions](https://docs.microsoft.com/en-us/windows/win32/sync/wait-functions)
- [https://docs.microsoft.com/en-gb/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitforsingleobject](https://docs.microsoft.com/en-gb/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitforsingleobject)
- [https://docs.microsoft.com/en-gb/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitformultipleobjects](https://docs.microsoft.com/en-gb/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitformultipleobjects)
- [https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/waits-and-apcs](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/waits-and-apcs)
- [https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/managing-hardware-priorities](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/managing-hardware-priorities)
- [https://blogs.msdn.microsoft.com/doronh/2010/02/02/what-is-irql/](https://blogs.msdn.microsoft.com/doronh/2010/02/02/what-is-irql/)
- [https://docs.microsoft.com/en-us/windows/win32/sysinfo/object-manager](https://docs.microsoft.com/en-us/windows/win32/sysinfo/object-manager)
- [http://bsodtutorials.blogspot.com/2014/01/rootkits-direct-kernel-object.html](http://bsodtutorials.blogspot.com/2014/01/rootkits-direct-kernel-object.html)
- [https://docs.microsoft.com/en-us/windows/win32/sync/synchronization-objects](https://docs.microsoft.com/en-us/windows/win32/sync/synchronization-objects)
- [https://docs.microsoft.com/en-us/windows/win32/sync/interlocked-variable-access](https://docs.microsoft.com/en-us/windows/win32/sync/interlocked-variable-access)
- [https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-spin-locks](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-spin-locks)
- [https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-mutex-objects](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-mutex-objects)
- [https://docs.microsoft.com/en-us/windows/win32/sync/critical-section-objects](https://docs.microsoft.com/en-us/windows/win32/sync/critical-section-objects)
- [https://www.felixcloutier.com/x86/lock](https://www.felixcloutier.com/x86/lock)
- [https://www.felixcloutier.com/x86/bts](https://www.felixcloutier.com/x86/bts)
## APC
- Async Procedural Call
- Thread runs APC next time an alertable thread is scheduled.
- ![[Pasted image 20251112224354.png]]
- Above is Interrupt Request Level (IRQL)
- IRQL has various constraints for exploitation.
## Executive Process
- `_EPROCESS` in kernel memory.
- Information about the process, pointers to other relevant structures are the contents of this.
- Each process has a `_PEB` process environment block in memory.
- `PsActiveProcessHead` , `PsIdleProcess`
- `_KPRCB` contains a pointer to the current thread's `_KTHREAD`.
- `_EPROCESS` contains a pointer to the linked list.